

<div class="container mx-auto px-4 py-8">
  @if(post(); as post) {
    <div class="max-w-4xl mx-auto">
      <div class="mb-4">
        <a routerLink="/community" class="text-primary hover:underline">&larr; {{ 'forumBackToCommunity' | translate }}</a>
      </div>

      <!-- Post -->
      <div class="bg-slate-900 rounded-lg flex gap-4 p-6">
        <!-- Votes -->
        <div class="flex flex-col items-center flex-shrink-0 text-slate-400 w-10">
          <button (click)="handleVote('up')" [disabled]="!currentUser()" class="p-1 transition" [class.text-green-500]="hasVoted('up')" [class.hover:text-green-500]="!hasVoted('up')" [class.disabled:cursor-not-allowed]="!currentUser()" [class.disabled:text-slate-600]="!currentUser()">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.516.372-.648A.755.755 0 0 1 12 1.7v1.368l2.22 1.85A.75.75 0 0 1 15 5.5v5.617l1.007 2.517a2.25 2.25 0 0 1-2.243 2.866H6.25a1.25 1.25 0 0 1-1.25-1.25V8.25a1.25 1.25 0 0 1 1.25-1.25h3.5a.75.75 0 0 0 .75-.75V3Z" /></svg>
          </button>
          <span class="font-bold my-1 text-white">{{ post.upvotes - post.downvotes }}</span>
          <button (click)="handleVote('down')" [disabled]="!currentUser()" class="p-1 transition" [class.text-red-500]="hasVoted('down')" [class.hover:text-red-500]="!hasVoted('down')" [class.disabled:cursor-not-allowed]="!currentUser()" [class.disabled:text-slate-600]="!currentUser()">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M19 11.75a1.25 1.25 0 1 1-2.5 0v-7.5a1.25 1.25 0 1 1 2.5 0v7.5ZM9 17v1.3c0 .268-.14-.516-.372-.648A.755.755 0 0 1 8 18.3v-1.368L5.78 15.08A.75.75 0 0 1 5 14.5v-5.617L3.993 6.366a2.25 2.25 0 0 1 2.243-2.867h6.514a1.25 1.25 0 0 1 1.25 1.25v7.5a1.25 1.25 0 0 1-1.25 1.25h-3.5a.75.75 0 0 0-.75.75V17Z" /></svg>
          </button>
        </div>

        <!-- Content -->
        <div class="flex-grow min-w-0">
          <div class="flex items-center gap-3 text-sm text-slate-400 mb-2">
            <span class="font-bold" [class]="getCategoryColor(post.category)">#{{ ('forum' + post.category) | translate }}</span>
            <span>&middot;</span>
            <span>{{ 'forumPostedBy' | translate }} {{ post.authorUsername }} {{ timeSince(post.createdAt) }}</span>
          </div>
          <h1 class="text-3xl font-bold text-white mb-4">{{ post.title }}</h1>
          <p class="text-slate-300 whitespace-pre-wrap">{{ post.content }}</p>
          @if (canModifyPost()) {
            <div class="flex items-center gap-4 mt-4 text-sm text-slate-400">
              <button (click)="openEditModal()" class="font-semibold hover:text-white transition">{{ 'edit' | translate }}</button>
              <button (click)="handleDeletePost()" class="font-semibold hover:text-red-400 transition">{{ 'delete' | translate }}</button>
            </div>
          }
        </div>
      </div>

      <!-- Add Comment Form -->
      <div class="mt-8">
        @if(currentUser(); as user) {
          <form (ngSubmit)="addComment()" class="mb-8">
            <h3 class="text-xl font-semibold mb-2">{{ 'forumLeaveAComment' | translate }}</h3>
            <textarea
              rows="4"
              [(ngModel)]="newCommentText"
              name="newComment"
              placeholder="{{ 'forumCommentPlaceholder' | translate }}"
              class="w-full p-3 bg-slate-800 border border-slate-700 rounded-md focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
            <div class="flex justify-end mt-2">
              <button 
                type="submit" 
                [disabled]="!newCommentText().trim()"
                class="bg-primary text-white px-6 py-2 rounded-md font-bold hover:bg-red-700 transition disabled:bg-slate-600 disabled:cursor-not-allowed">
                {{ 'forumComment' | translate }}
              </button>
            </div>
          </form>
        } @else {
          <p class="text-slate-400 text-center bg-slate-800 p-4 rounded-lg mb-8">
            {{ 'mustBeLoggedInToComment' | translate }}
          </p>
        }
      </div>

      <!-- Comments Section -->
      <div class="space-y-6">
        @for(comment of post.comments; track comment.id) {
          <app-comment 
            [postId]="post.id"
            [comment]="comment"
            (reply)="handleReply($event)"
            (vote)="handleCommentVote($event)"
            (edit)="handleCommentEdit($event)"
            (delete)="handleCommentDelete($event)"
            />
        } @empty {
          <div class="text-center py-10">
            <p class="text-slate-500">{{ 'forumBeFirstToComment' | translate }}</p>
          </div>
        }
      </div>
    </div>
  } @else {
    <div class="text-center py-20">
      <h1 class="text-4xl font-bold text-primary mb-4">{{ 'forumPostNotFound' | translate }}</h1>
      <p class="text-gray-400 text-lg">{{ 'forumPostNotFoundMessage' | translate }}</p>
    </div>
  }
</div>

@if (showEditModal()) {
  <app-create-post-modal 
    [post]="postToEdit()"
    [categories]="categoryNames()"
    (save)="handleSavePost($event)" 
    (close)="showEditModal.set(false)" />
}
