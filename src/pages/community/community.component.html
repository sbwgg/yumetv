

<div class="container mx-auto px-4 py-8">
  <div class="flex flex-col md:flex-row gap-8">
    
    <!-- Left Sidebar -->
    <aside class="w-full md:w-64 flex-shrink-0">
      <div class="space-y-2">
        <button 
          (click)="selectCategory('All')" 
          class="w-full flex justify-between items-center px-4 py-2 rounded-lg transition-colors font-semibold"
          [class.bg-slate-700]="activeCategory() === 'All' && !showMyPosts()"
          [class.hover:bg-slate-800]="activeCategory() !== 'All' || showMyPosts()">
          <span>#{{ 'forumAll' | translate }}</span>
        </button>
        @for(cat of categories(); track cat.name) {
          <button 
            (click)="selectCategory(cat.name)"
            class="w-full flex justify-between items-center px-4 py-2 rounded-lg transition-colors font-semibold"
            [class.bg-slate-700]="activeCategory() === cat.name && !showMyPosts()"
            [class.hover:bg-slate-800]="activeCategory() !== cat.name || showMyPosts()">
            <span [class]="getCategoryColor(cat.name)">#{{ ('forum' + cat.name) | translate }}</span>
            <span class="bg-slate-800 text-slate-400 text-xs px-2 py-0.5 rounded-full">{{ cat.count }} {{ 'forumPostsSuffix' | translate }}</span>
          </button>
        }
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow min-w-0">
      <!-- Header -->
      <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
        <div class="flex items-center gap-2">
          @if(currentUser()) {
            <button (click)="openCreateModal()" class="flex items-center gap-2 bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded-lg font-semibold transition">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5v-4.5Z" /></svg>
              {{ 'forumCreate' | translate }}
            </button>
            <button (click)="toggleMyPosts()" class="flex items-center gap-2 px-4 py-2 rounded-lg font-semibold transition"
              [class.bg-slate-700]="showMyPosts()"
              [class.hover:bg-slate-800]="!showMyPosts()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM3.465 14.493a1.23 1.23 0 0 0 .41 1.412A9.957 9.957 0 0 0 10 18c2.31 0 4.438-.784 6.131-2.1.43-.333.604-.903.408-1.41a7.002 7.002 0 0 0-13.074 0Z" /></svg>
              {{ 'forumMyPosts' | translate }}
            </button>
          }
        </div>
        <div class="flex items-center gap-2">
          <label for="sort" class="text-slate-400 font-semibold">{{ 'forumSortBy' | translate }}</label>
          <select id="sort" [(ngModel)]="sortBy" class="bg-slate-800 border border-slate-700 rounded-lg px-3 py-1.5 focus:ring-2 focus:ring-primary focus:outline-none">
            <option value="newest">{{ 'forumSortNewest' | translate }}</option>
            <option value="oldest">{{ 'forumSortOldest' | translate }}</option>
            <option value="top">{{ 'forumSortTop' | translate }}</option>
          </select>
        </div>
      </div>

      <!-- Posts List -->
      <div class="space-y-4">
        @for(post of filteredPosts(); track post.id) {
          <div 
            class="rounded-lg flex gap-4 p-4 transition-colors"
            [class.bg-pinned-bg]="post.isPinned"
            [class.bg-slate-900]="!post.isPinned">
            <!-- Votes -->
            <div class="flex flex-col items-center flex-shrink-0 text-slate-400 w-10">
              <button (click)="handleVote(post.id, 'up')" [disabled]="!currentUser()" class="p-1 transition" [class.text-green-500]="hasVoted(post, 'up')" [class.hover:text-green-500]="!hasVoted(post, 'up')" [class.disabled:cursor-not-allowed]="!currentUser()" [class.disabled:text-slate-600]="!currentUser()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path d="M1 8.25a1.25 1.25 0 1 1 2.5 0v7.5a1.25 1.25 0 1 1-2.5 0v-7.5ZM11 3V1.7c0-.268.14-.516.372-.648A.755.755 0 0 1 12 1.7v1.368l2.22 1.85A.75.75 0 0 1 15 5.5v5.617l1.007 2.517a2.25 2.25 0 0 1-2.243 2.866H6.25a1.25 1.25 0 0 1-1.25-1.25V8.25a1.25 1.25 0 0 1 1.25-1.25h3.5a.75.75 0 0 0 .75-.75V3Z" />
                </svg>
              </button>
              <span class="font-bold my-1 text-white">{{ post.upvotes - post.downvotes }}</span>
              <button (click)="handleVote(post.id, 'down')" [disabled]="!currentUser()" class="p-1 transition" [class.text-red-500]="hasVoted(post, 'down')" [class.hover:text-red-500]="!hasVoted(post, 'down')" [class.disabled:cursor-not-allowed]="!currentUser()" [class.disabled:text-slate-600]="!currentUser()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                  <path d="M19 11.75a1.25 1.25 0 1 1-2.5 0v-7.5a1.25 1.25 0 1 1 2.5 0v7.5ZM9 17v1.3c0 .268-.14-.516-.372-.648A.755.755 0 0 1 8 18.3v-1.368L5.78 15.08A.75.75 0 0 1 5 14.5v-5.617L3.993 6.366a2.25 2.25 0 0 1 2.243-2.867h6.514a1.25 1.25 0 0 1 1.25 1.25v7.5a1.25 1.25 0 0 1-1.25 1.25h-3.5a.75.75 0 0 0-.75.75V17Z" />
                </svg>
              </button>
            </div>

            <!-- Content -->
            <div class="flex-grow min-w-0">
              <div class="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-slate-400 mb-2">
                @if(post.isPinned) {
                  <span class="font-bold flex items-center gap-1 bg-pinned-tag-bg text-pinned-tag-text px-2 py-0.5 rounded">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4"><path d="M5.011 3.225 3.225 5.011a.75.75 0 0 1-1.06-1.061l1.786-1.786a.75.75 0 0 1 1.06 1.061ZM10.99 3.225a.75.75 0 1 0-1.06-1.06L8.145 3.951a.75.75 0 0 0 1.06 1.06l1.786-1.786ZM5.75 11a.75.75 0 0 1 .75-.75h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1-.75-.75Zm.97-4.155a.75.75 0 0 0-1.061 1.06l1.786 1.786a.75.75 0 0 0 1.06-1.06L6.72 6.845ZM11.855 8.645a.75.75 0 0 0-1.06-1.06L8.98 9.37a.75.75 0 0 0 1.061 1.06l1.814-1.786Z" /><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 1 0 0 13a6.5 6.5 0 0 0 0-13ZM2.5 8a5.5 5.5 0 0 1 10.635-1.5H2.865A5.482 5.482 0 0 1 2.5 8Z" clip-rule="evenodd" /></svg>
                    {{ 'forumPinned' | translate }}
                  </span>
                }
                <span class="font-bold" [class]="getCategoryColor(post.category)">#{{ ('forum' + post.category) | translate }}</span>
                <span>&middot;</span>
                <span>{{ timeSince(post.createdAt) }}</span>
              </div>
              <a [routerLink]="['/community/post', post.id]">
                <h3 class="text-lg font-bold text-white mb-2 hover:underline">{{ post.title }}</h3>
              </a>
              <p class="text-slate-400 text-sm mb-3 line-clamp-2">{{ post.content }}</p>

              <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                  <img [src]="post.authorProfilePictureUrl || 'https://picsum.photos/seed/default/40/40'" [alt]="post.authorUsername" class="w-6 h-6 rounded-full object-cover">
                  <span class="text-sm font-semibold text-slate-300">{{ post.authorUsername }}</span>
                  @if (post.authorRole !== 'user') {
                    <span class="px-2 py-0.5 text-xs font-bold rounded-md" [class.bg-primary]="post.authorRole === 'admin'" [class.bg-blue-600]="post.authorRole === 'mod'">
                      {{ post.authorRole | titlecase }}
                    </span>
                  }
                </div>
                <div class="flex items-center gap-4 text-slate-400">
                  <div class="flex items-center gap-3 text-sm">
                    @if (isAdminOrMod()) {
                      <button (click)="handlePinPost(post.id)" class="font-semibold hover:text-amber-400 transition">{{ post.isPinned ? ('forumUnpin' | translate) : ('forumPin' | translate) }}</button>
                    }
                    @if (isAdminOrMod() || (currentUser() && post.authorId === currentUser()!.id)) {
                      <button (click)="openEditModal(post)" class="font-semibold hover:text-sky-400 transition">{{ 'edit' | translate }}</button>
                      <button (click)="handleDeletePost(post.id)" class="font-semibold hover:text-red-500 transition">{{ 'delete' | translate }}</button>
                    }
                  </div>
                  <div class="flex items-center gap-1.5 text-sm font-semibold">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M2 5.25A3.25 3.25 0 0 1 5.25 2h9.5A3.25 3.25 0 0 1 18 5.25v6.5A3.25 3.25 0 0 1 14.75 15h-3.191l-3.213 2.57a.75.75 0 0 1-1.159-.578V15H5.25A3.25 3.25 0 0 1 2 11.75v-6.5ZM5.25 3.5a1.75 1.75 0 0 0-1.75 1.75v6.5c0 .966.784 1.75 1.75 1.75h2a.75.75 0 0 1 .75.75v1.19l1.72-1.376a.75.75 0 0 1 .43-.164h4.3a1.75 1.75 0 0 0 1.75-1.75v-6.5A1.75 1.75 0 0 0 14.75 3.5h-9.5Z" clip-rule="evenodd" /></svg>
                    <span>{{ post.comments.length }}</span>
                  </div>
                </div>
              </div>
            </div>

          </div>
        } @empty {
          <div class="text-center py-16 bg-slate-900 rounded-lg">
            <p class="text-slate-400">{{ 'forumNoPostsFound' | translate }}</p>
          </div>
        }
      </div>
    </main>
  </div>
</div>

@if (showCreateModal()) {
  <app-create-post-modal 
    [post]="postToEdit()"
    [categories]="categoryNames()"
    (save)="handleSavePost($event)" 
    (close)="showCreateModal.set(false)" />
}